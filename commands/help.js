const User = require('../models/User');
const addressForms = require('../utils/addressForms');

module.exports = {
  command: 'help',
  description: 'Show available commands',
  execute: async (bot, msg) => {
    const chatId = msg.chat.id;
    const telegramId = msg.from.id;
    
    try {
      const user = await User.findOne({ telegramId });

      const helpMessage = addressForms.formatForUser(
        `üìö <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n\n` +
        `üöÄ <b>–û—Å–Ω–æ–≤–Ω—ã–µ:</b>\n` +
        `/start - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –±–æ—Ç–µ\n` +
        `/survey - –ù–∞—á–∞—Ç—å –æ–ø—Ä–æ—Å\n` +
        `/stats - –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n` +
        `/settings - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\n\n` +
        `üéÆ <b>–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è:</b>\n` +
        `/achievements - –¢–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å\n` +
        `/leaderboard - –†–µ–π—Ç–∏–Ω–≥–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∞–Ω–æ–Ω–∏–º–Ω–æ)\n\n` +
        `üß† <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:</b>\n` +
        `/insights - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã\n\n` +
        `‚ÑπÔ∏è <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ:</b>\n` +
        `/help - –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n` +
        `/news - –ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ üÜï\n` +
        `/info - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ\n` +
        `/echo [—Ç–µ–∫—Å—Ç] - –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ\n` +
        `/export - –≠–∫—Å–ø–æ—Ä—Ç —Ç–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö\n\n` +
        `üí° <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!`,
        user
      );

      bot.sendMessage(chatId, helpMessage, { parse_mode: 'HTML' });
    } catch (error) {
      console.error('Error in help command:', error);
      // Fallback to informal address if user not found
      const helpMessage = `üìö <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n\n` +
        `üöÄ <b>–û—Å–Ω–æ–≤–Ω—ã–µ:</b>\n` +
        `/start - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –±–æ—Ç–µ\n` +
        `/survey - –ù–∞—á–∞—Ç—å –æ–ø—Ä–æ—Å\n` +
        `/stats - –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n` +
        `/settings - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\n\n` +
        `üéÆ <b>–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è:</b>\n` +
        `/achievements - –¢–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å\n` +
        `/leaderboard - –†–µ–π—Ç–∏–Ω–≥–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∞–Ω–æ–Ω–∏–º–Ω–æ)\n\n` +
        `üß† <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:</b>\n` +
        `/insights - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã\n\n` +
        `‚ÑπÔ∏è <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ:</b>\n` +
        `/help - –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n` +
        `/news - –ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ üÜï\n` +
        `/info - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ\n` +
        `/echo [—Ç–µ–∫—Å—Ç] - –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ\n` +
        `/export - –≠–∫—Å–ø–æ—Ä—Ç —Ç–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö\n\n` +
        `üí° <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!`;

      bot.sendMessage(chatId, helpMessage, { parse_mode: 'HTML' });
    }
  }
};